<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base target="_top" />
  <title>Class Assessment Form</title>
  <style>
    :root {
      --blue: #0056b3;
      --orange: #ff7b00;
      --gray-bg: #f8fafc;
      --border: #d1d5db;
    }

    body {
      font-family: "Inter", "Segoe UI", sans-serif;
      background-color: var(--gray-bg);
      margin: 0;
      color: #111827;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #fff;
      padding: 14px 20px;
      border-bottom: 3px solid var(--orange);
    }

    .header h1 {
      color: var(--blue);
      font-size: 1.6em;
      margin: 0;
      font-weight: 700;
    }

    .header img {
      height: 50px;
    }

  .container {
    max-width: 1400px; /* üëà aumentei de 1200px */
    width: 97%;
    background-color: #fff;
    margin: 40px auto;
    padding: 50px 60px; /* üëà mais espa√ßo interno */
    border-radius: 16px;
    box-shadow: 0 5px 16px rgba(0, 0, 0, 0.08);
  }


  h2 {
  display: flex;
  align-items: center;
  font-size: 1.2em;
  color: var(--blue);
  margin-bottom: 12px;
  font-weight: 700;
  }

/* üîπ Restaura a barrinha decorativa azul √† esquerda dos t√≠tulos */
  h2::before {
  content: "‚ñç";
  color: var(--blue);
  margin-right: 8px;
  font-size: 1.4em;
  line-height: 1;
  }


    label {
      font-weight: 600;
      margin-top: 10px;
      display: block;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .full {
      grid-column: 1 / 3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 18px;
      display: none;
    }

    th,
    td {
      border: 1px solid #e5e7eb;
      padding: 8px;
    }

    th {
      background: var(--blue);
      color: #fff;
    }

    .submit-wrap {
      text-align: center;
      margin-top: 28px;
    }

    .submit-btn {
      background: var(--orange);
      color: #fff;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .message {
      display: none;
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
    }

    .success {
      background: #ecfdf5;
      color: #065f46;
    }

    .error {
      background: #fef2f2;
      color: #991b1b;
    }

    #gradeHint {
      background: #f3f4f6;
      border-left: 4px solid var(--orange);
      padding: 8px 12px;
      border-radius: 6px;
      color: #374151;
      font-size: 0.95em;
      font-style: italic;
      display: none;
      margin-bottom: 10px;
    }

    /* üîß Corrige altura, alinhamento e consist√™ncia dos inputs */
    input,
    select,
    textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background-color: #fff;
      font-family: "Inter", "Segoe UI", sans-serif;
      font-size: 0.95em;
      color: #000;
      box-sizing: border-box;
      height: 42px;
      /* üëà mant√©m altura uniforme */
      line-height: 1.4em;
    }

    /* üîß Corrige o date picker */
    input[type="date"] {
      appearance: none;
      -webkit-appearance: none;
      background-color: #fff;
      cursor: pointer;
      height: 42px;
    }

    /* üîß Campo de notas com setas e incrementos */
    input[type="number"].spinner {
      appearance: none;
      -moz-appearance: textfield;
      text-align: center;
      width: 90px;
      height: 36px;
    }

    input[type="number"].spinner::-webkit-outer-spin-button,
    input[type="number"].spinner::-webkit-inner-spin-button {
      -webkit-appearance: inner-spin-button;
      opacity: 1;
      height: 1.2em;
      cursor: pointer;
    }

    /* üîß Centraliza o input de nota na c√©lula da tabela */
    td input[type="number"] {
      display: block;
      margin: 0 auto;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>Class Assessment Form</h1>
    <img id="bindiLogo" />
  </div>

  <div class="container">
    <h2>General Information</h2>
    <form id="reportForm">
      <div class="grid">
        <div><label>Region *</label><select id="region" required></select></div>
        <div><label>City *</label><select id="city" required></select></div>
        <div><label>School *</label><select id="school" required></select></div>
        <div><label>Teacher *</label><select id="teacher" required></select></div>
        <div><label>Date *</label><input type="date" id="classDate" required /></div>
        <div><label>Group *</label><select id="grade" required></select></div>
        <div><label>Subject *</label><select id="subject" required></select></div>
        <div class="full"><label>General Notes</label><textarea id="notes"></textarea></div>
      </div>

      <h2>Student Assessment</h2>
      <p id="gradeHint"></p>

      <div>
        <label>Assessment Type *</label>
        <select id="gradeType" required>
          <option value="">Select</option>
          <option value="Quarterly">Quarterly</option>
          <option value="Monthly">Monthly</option>
        </select>
      </div>

      <div id="quarterContainer" style="display:none;">
        <label>Select Quarter *</label>
        <select id="quarter">
          <option value="">Select</option>
          <option value="Q1">Q1 (May - July)</option>
          <option value="Q2">Q2 (Aug - Oct)</option>
          <option value="Q3">Q3 (Nov - Jan)</option>
          <option value="Q4">Q4 (Feb - Mar)</option>
        </select>
      </div>

      <div id="monthContainer" style="display:none;">
        <label>Select Month *</label>
        <select id="month">
          <option value="">Select</option>
          <option value="1">January</option>
          <option value="2">February</option>
          <option value="3">March</option>
          <option value="4">April</option>
          <option value="5">May</option>
          <option value="6">June</option>
          <option value="7">July</option>
          <option value="8">August</option>
          <option value="9">September</option>
          <option value="10">October</option>
          <option value="11">November</option>
          <option value="12">December</option>
        </select>
      </div>

      <table id="studentsTable">
        <thead>
          <tr>
            <th>Student Name</th>
            <th>Assessment</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h2>Upload Class Photos</h2>
      <input type="file" id="photos" accept="image/*" multiple />
      <div class="submit-wrap">
        <button type="button" class="submit-btn" id="submitBtn">Submit Report</button>
      </div>
      <div class="message success" id="successMessage">‚úÖ Report submitted successfully!</div>
      <div class="message error" id="errorMessage">‚ùå Error submitting report.</div>
    </form>
  </div>

  <script>
    // === Fun√ß√µes auxiliares ===
    function getGradeLimits(type) {
      if (type === "Quarterly") return { min: 0, max: 25, message: "Please enter a value between 0 and 25 (Quarterly assessment)." };
      if (type === "Monthly") return { min: 0, max: 20, message: "Please enter a value between 0 and 20 (Monthly assessment)." };
      return { min: 0, max: 25, message: "" };
    }

    function validateGrade(el) {
      const val = parseFloat(el.value);
      const min = parseFloat(el.min);
      const max = parseFloat(el.max);
      if (isNaN(val)) return;
      if (val < min) el.value = min;
      if (val > max) el.value = max;
    }

    function setLoading(el, loading, placeholder = "Loading...") {
      if (!el) return;
      if (loading) {
        el.disabled = true;
        el.style.opacity = "0.7";
        el.innerHTML = `<option value="">${placeholder}</option>`;
      } else {
        el.disabled = false;
        el.style.opacity = "1";
      }
    }


    google.script.run.withSuccessHandler(url => {
      const logo = document.getElementById("bindiLogo");
      if (url) logo.src = url;
    }).getLogoUrl();

    // === Dropdowns ===
    const regionEl = document.getElementById("region");
    const cityEl = document.getElementById("city");
    const schoolEl = document.getElementById("school");
    const teacherEl = document.getElementById("teacher");
    const gradeEl = document.getElementById("grade");
    const subjectEl = document.getElementById("subject");

    const gradeTypeEl = document.getElementById("gradeType");
    const quarterC = document.getElementById("quarterContainer");
    const monthC = document.getElementById("monthContainer");

    gradeTypeEl.onchange = () => {
      quarterC.style.display = gradeTypeEl.value === "Quarterly" ? "block" : "none";
      monthC.style.display = gradeTypeEl.value === "Monthly" ? "block" : "none";
      const { message } = getGradeLimits(gradeTypeEl.value);
      const hint = document.getElementById("gradeHint");
      hint.textContent = message || "";
      hint.style.display = message ? "block" : "none";
    };

    function fillSelect(el, list, placeholder="Select") {
      el.innerHTML = `<option value="">${placeholder}</option>`;
      (list||[]).forEach(v => {
        const o=document.createElement("option"); o.value=v; o.textContent=v; el.appendChild(o);
      });
    }

    window.onload = () => {
      setLoading(regionEl, true);
      google.script.run.withSuccessHandler(r => {
        fillSelect(regionEl, r, "Select region");
        setLoading(regionEl, false);
      }).getRegions();
    };

      regionEl.onchange = () => {
      setLoading(cityEl, true);
      google.script.run.withSuccessHandler(c => {
        fillSelect(cityEl, c, "Select city");
        setLoading(cityEl, false);
      }).getCities(regionEl.value);
    };


    cityEl.onchange = () => {
      setLoading(schoolEl, true);
      google.script.run.withSuccessHandler(s => {
        fillSelect(schoolEl, s, "Select school");
        setLoading(schoolEl, false);
      }).getSchools(regionEl.value, cityEl.value);
    };


    schoolEl.onchange = () => {
      const region = regionEl.value, city = cityEl.value, school = schoolEl.value;
      if (!school) return;

      setLoading(teacherEl, true);
      setLoading(gradeEl, true);
      setLoading(subjectEl, true);

      google.script.run.withSuccessHandler(t => {
        fillSelect(teacherEl, t, "Select teacher");
        setLoading(teacherEl, false);
      }).getTeachers(region, city, school);

      google.script.run.withSuccessHandler(g => {
        fillSelect(gradeEl, g, "Select group");
        setLoading(gradeEl, false);
      }).getGroups(region, city, school);

      google.script.run.withSuccessHandler(subs => {
        fillSelect(subjectEl, subs, "Select subject");
        setLoading(subjectEl, false);
      }).getSubjects(region, city, school);
    };


    // === Carregar alunos ===
    document.getElementById("grade").onchange = () => {
      const region=regionEl.value, city=cityEl.value, school=schoolEl.value, group=gradeEl.value;
      if(!group)return;
      const table=document.getElementById("studentsTable"), tbody=table.querySelector("tbody");
      tbody.innerHTML="<tr><td colspan='2'>Loading students...</td></tr>";
      table.style.display="table";

      google.script.run.withSuccessHandler(students => showStudents(students)).getStudents(region,city,school,group);
    };

    function showStudents(students){
      const table=document.getElementById("studentsTable");
      const tbody=table.querySelector("tbody");
      tbody.innerHTML="";
      if(!students.length){table.style.display="none";return;}
      const {min,max}=getGradeLimits(document.getElementById("gradeType").value);
      students.forEach(s=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${s}</td><td><input type="number" class="grade-input spinner" step="0.5" min="${min}" max="${max}" oninput="validateGrade(this)" /></td>`;
        tbody.appendChild(tr);
      });
      table.style.display="table";
    }

    // === Enviar formul√°rio (‚öôÔ∏è principal corre√ß√£o) ===
document.getElementById("submitBtn").onclick = async () => {
  const submitBtn = document.getElementById("submitBtn");
  const successMsg = document.getElementById("successMessage");
  const errorMsg = document.getElementById("errorMessage");

  successMsg.style.display = "none";
  errorMsg.style.display = "none";

  // üîç Verifica campos obrigat√≥rios antes do envio
  const requiredFields = [
    { id: "region", label: "Region" },
    { id: "city", label: "City" },
    { id: "school", label: "School" },
    { id: "teacher", label: "Teacher" },
    { id: "classDate", label: "Date" },
    { id: "grade", label: "Group" },
    { id: "subject", label: "Subject" },
    { id: "gradeType", label: "Assessment Type" },
  ];

  const missing = requiredFields.filter(f => !document.getElementById(f.id).value);

  if (missing.length > 0) {
    const names = missing.map(f => f.label).join(", ");
    errorMsg.innerHTML = `‚ö†Ô∏è Please fill all required fields: <b>${names}</b>.`;
    errorMsg.style.display = "block";
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit Report";
    window.scrollTo({ top: 0, behavior: "smooth" });
    return;
  }

  // üîç Valida√ß√£o adicional: Quarterly ou Monthly requer um campo espec√≠fico
  const gradeType = document.getElementById("gradeType").value;
  if (gradeType === "Quarterly" && !document.getElementById("quarter").value) {
    errorMsg.innerHTML = `‚ö†Ô∏è Please select the quarter.`;
    errorMsg.style.display = "block";
    window.scrollTo({ top: 0, behavior: "smooth" });
    return;
  }
  if (gradeType === "Monthly" && !document.getElementById("month").value) {
    errorMsg.innerHTML = `‚ö†Ô∏è Please select the month.`;
    errorMsg.style.display = "block";
    window.scrollTo({ top: 0, behavior: "smooth" });
    return;
  }

  // ‚úÖ Se tudo estiver preenchido, prossegue normalmente
  submitBtn.disabled = true;
  submitBtn.textContent = "‚è≥ Submitting...";

  const data = {
    region: regionEl.value,
    city: cityEl.value,
    school: schoolEl.value,
    teacher: teacherEl.value,
    classDate: document.getElementById("classDate").value,
    grade: gradeEl.value,
    subject: subjectEl.value,
    notes: document.getElementById("notes").value,
    gradeType: gradeType,
    quarter: document.getElementById("quarter").value,
    month: document.getElementById("month").value
  };

  const students = Array.from(document.querySelectorAll("#studentsTable tbody tr")).map(tr => ({
    name: tr.children[0].textContent.trim(),
    grade: tr.children[1].querySelector("input").value
  }));

  const photos = await Promise.all(
    Array.from(document.getElementById("photos").files).map(f =>
      new Promise(res => {
        const r = new FileReader();
        r.onload = e => res({ name: f.name, data: e.target.result });
        r.readAsDataURL(f);
      })
    )
  );

  google.script.run
    .withSuccessHandler(r => {
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit Report";

      if (r && r.success) {
        successMsg.textContent = "‚úÖ Report submitted successfully!";
        successMsg.style.display = "block";
        errorMsg.style.display = "none";
        window.scrollTo({ top: 0, behavior: "smooth" });

        setTimeout(() => location.reload(), 2000);
      } else {
        errorMsg.textContent = r.message || "‚ùå Error submitting report.";
        errorMsg.style.display = "block";
        successMsg.style.display = "none";
      }
    })
    .withFailureHandler(err => {
      console.error("‚ùå Submit error:", err);
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit Report";
      errorMsg.textContent = "‚ùå Network or server error.";
      errorMsg.style.display = "block";
      successMsg.style.display = "none";
      window.scrollTo({ top: 0, behavior: "smooth" });
    })
    .submitForm(data, photos, students);
};

  </script>
</body>

</html>
